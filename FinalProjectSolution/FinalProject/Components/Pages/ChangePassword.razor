@page "/change-password"
@layout FinalProject.Components.Layout.AuthLayout
@rendermode InteractiveServer

@using FinalProject.Dtos
@using FinalProject.Models
@using FinalProject.Services
@using Microsoft.EntityFrameworkCore

@inject AppDbContext Db
@inject IHttpContextAccessor Http
@inject NavigationManager Nav


<h3>Ganti Password</h3>

<EditForm Model="model" OnValidSubmit="HandleSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label>Password Lama</label>
        <InputText type="password" class="form-control" @bind-Value="model.CurrentPassword" />
    </div>

    <div class="mb-3">
        <label>Password Baru</label>
        <InputText type="password" class="form-control" @bind-Value="model.NewPassword" />
    </div>

    <div class="mb-3">
        <label>Konfirmasi Password</label>
        <InputText type="password" class="form-control" @bind-Value="model.ConfirmPassword" />
    </div>

    <button class="btn btn-danger">
        Ganti Password
    </button>

    <a class="btn btn-secondary ms-2" href="/profile">
        Batal
    </a>
</EditForm>

@if (!string.IsNullOrEmpty(error))
{
    <div class="alert alert-danger mt-3">
        @error
    </div>
}

@code {
    private ChangePasswordDto model = new();
    private string? error;
    private readonly UserLogService _log;

    protected override void OnInitialized()
    {
        // proteksi halaman (harus login)
        var email = Http.HttpContext?.Session.GetString("AUTH_EMAIL");
        if (email == null)
        {
            Nav.NavigateTo("/login", true);
        }
    }

    private async Task HandleSubmit()
    {
        error = null;

        // ambil session
        var email = Http.HttpContext?.Session.GetString("AUTH_EMAIL");
        if (email == null)
        {
            error = "Session habis. Silakan login ulang.";
            return;
        }

        // ðŸ‘¤ ambil user
        var user = await Db.Users.FirstOrDefaultAsync(u => u.Email == email);
        if (user == null)
        {
            error = "User tidak ditemukan.";
            return;
        }

        // cek password lama
        if (!BCrypt.Net.BCrypt.Verify(
        model.CurrentPassword,
        user.PasswordHash))
        {
            error = "Password lama salah.";
            return;
        }

        // password baru == lama
        if (BCrypt.Net.BCrypt.Verify(
        model.NewPassword,
        user.PasswordHash))
        {
            error = "Password baru tidak boleh sama dengan password lama.";
            return;
        }

        // update password
        user.PasswordHash =
        BCrypt.Net.BCrypt.HashPassword(model.NewPassword);

        await Db.SaveChangesAsync();

        await _log.LogAsync(user.Email, "CHANGE_PASSWORD");

        // logout paksa
        Http.HttpContext.Session.Clear();

        // redirect login
        Nav.NavigateTo(
        "/login?success=Password berhasil diubah, silakan login ulang",
        true
        );
    }
}